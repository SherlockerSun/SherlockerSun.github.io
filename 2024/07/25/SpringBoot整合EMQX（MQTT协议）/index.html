<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>SpringBoot整合EMQX（MQTT协议） | SherlockerSun</title><meta name="keywords" content="Java,技术分享,Springboot,网络协议"><meta name="author" content="SherlockerSun"><meta name="copyright" content="SherlockerSun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="SpringBoot整合EMQX（MQTT协议）"><meta name="application-name" content="SpringBoot整合EMQX（MQTT协议）"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot整合EMQX（MQTT协议）"><meta property="og:url" content="http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/index.html"><meta property="og:site_name" content="SherlockerSun"><meta property="og:description" content="SpringBoot整合EMQX（MQTT协议） 原文：springboot当中使用EMQX（MQTT协议）  1、MQTT协议1.1、MQTT简介MQTT 全称为 Message Queuing Telemetry Transport（消息队列遥测传输），是一种基于 发布&amp;#x2F;订阅 模式"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://example.com/img/default_cover.jpg"><meta property="article:author" content="SherlockerSun"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/img/default_cover.jpg"><meta name="description" content="SpringBoot整合EMQX（MQTT协议） 原文：springboot当中使用EMQX（MQTT协议）  1、MQTT协议1.1、MQTT简介MQTT 全称为 Message Queuing Telemetry Transport（消息队列遥测传输），是一种基于 发布&amp;#x2F;订阅 模式"><link rel="shortcut icon" href="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/icon/bee.png"><link rel="canonical" href="http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://sherlocker-twikoo.hf.space',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"cdn","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: {"appId":"4ZYLEFSWAR","apiKey":"83a095d87cfa338f81db2e262bce2f4a","indexName":"hexo","hits":{"per_page":6},"languages":{"input_placeholder":"输入关键词后按下回车查找","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":true,"limitCount":50,"languages":{"author":"作者: SherlockerSun","link":"链接: ","source":"来源: SherlockerSun","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'SherlockerSun',
  title: 'SpringBoot整合EMQX（MQTT协议）',
  postAI: '',
  pageFillDescription: 'SpringBoot整合EMQX（MQTT协议）, 1、MQTT协议, 1.1、MQTT简介, 1.2、MQTT 协议基本特点, 1.3、MQTT 应用行业, 1.4、MQTT 协议原理, 1.5、MQTT 协议基础概念, 1.5.1、会话（Session）, 1.5.2、订阅（Subscription）, 1.5.3、主题名（Topic Name）, 1.5.4、主题过滤器（Topic Filter）, 1.5.5、载荷（Payload）, 1.6、MQTT 协议进阶, 1.6.1、消息服务质量（QoS）, QoS 0（最多分发一次）, 1.6.2、QoS 在发布与订阅中的区别, 1.6.3、如何选择 MQTT QoS 等级, 1.6.4、清除会话（Clean Session）, 1.6.5、保活心跳（Keep Alive）, 1.6.6、保留消息（Retained Message）, 1.6.7、遗嘱消息（Will Message）, 2、EMQ X Cloud, 2.1、EMQ X Cloud简介, 2.2、EMQ X Cloud优势, 2.2.1、协议支持完整, 2.2.2、多种协议接入, 2.2.3、容量预估与伸缩, 2.3、EMQ X 和 RabbitMQ对比, 2.3.1、测试场景, 1.多对一, 2.一对多, 2.3.2、测试结果, 1.多对一, 2.一对多, 2.3.3、测试总结, 2.3.4、注意, 3、Eclipse Paho Java, 4、SpringBoot整合Eclipse Paho Java, 4.1、导入Maven依赖, 4.2、配置文件, 4.2.1、application.yml, 4.2.2、MqttProperties, 4.3、添加MQTT接受服务的客户端, 4.4、添加MQTT接受服务的回调类, 4.5、添加MQTT发送客户端, 4.6、添加MQTT发送客户端的回调类, 4.7、添加配置类, 4.8、启动服务的时候开启监听客户端, 4.9、测试类, 4.10、发送和接收消息测试, 4.10.1、发送消息, 4.10.2、接收消息, 4.11、可能出现的问题整合协议原文当中使用协议协议简介全称为消息队列遥测传输是一种基于发布订阅模式的轻量级物联网消息传输协议公司的安迪斯坦福克拉克及公司的阿兰尼普于年撰写了该协议的第一个版本之后便以简单易实现支持轻量且省带宽等众多特性逐渐成为了通讯的标准协议每个消息最少仅需个字节其中报头仅需个字节其余字节可以全部作为消息载荷就可以完成通信专为那些资源和空间有限功耗敏感的硬件所打造协议基本特点使用发布订阅消息模式提供了一对多的消息分发和应用程序的解耦不关心负载内容的消息传输提供种消息服务质量等级满足不同投递需求很小的传输消耗和协议数据交换最大限度减少网络流量提供连接异常断开时通知相关各方的机制应用行业作为一种低开销低带宽占用的即时通讯协议可以用极少的代码和带宽为联网设备提供实时可靠的消息服务它适用于硬件资源有限的设备及带宽有限的网络环境因此协议广泛应用于物联网移动互联网智能硬件车联网电力能源等行业协议原理基于发布订阅模式的协议中有三种角色发布者代理订阅者发布者向代理发布消息代理向订阅者转发这些消息通常情况下客户端的角色是发布者和订阅者服务器的角色是代理但实际上服务器也可能主动发布消息或者订阅主题客串一下客户端的角色为了方便理解传输的消息可以简化为主题和载荷两部分消息主题订阅者向代理订阅主题后一旦代理收到相应主题的消息就会向订阅者转发该消息消息载荷也可以理解为传输的数据订阅者在消息中真正关心的部分通常是业务相关的协议基础概念会话每个客户端与服务器建立连接后就是一个会话客户端和服务器之间有状态交互会话可以存在于一个网络连接之间也可以跨越多个连续的网络连接存在订阅订阅包含一个主题过滤器和一个最大的服务质量等级订阅与单个会话关联会话可以包含多于一个的订阅主题名附加在应用消息上的一个标签被用于匹配服务端已存在的订阅服务端会向所有匹配订阅的客户端发送此应用消息主题过滤器仅在订阅时使用的主题表达式可以包含通配符以匹配多个主题名就是可以通过通配符达到发一条消息多个主题能接受到消息的效果载荷对于报文来说载荷就是业务消息就是指发送的消息内容它可以是任意格式二进制十六进制普通字符串字符串的数据协议进阶消息服务质量协议提供了种消息服务质量等级它保证了在不同的网络环境下消息传递的可靠性这里有一点要明白必须先订阅发布消息才会收到假如没订阅他发送消息了我再订阅这时候不管设置几都是收不到消息的最多分发一次当为时消息的分发依赖于底层网络的能力发布者只会发布一次消息接收者不会应答消息发布者也不会储存和重发消息消息在这个等级下具有最高的传输效率但可能送达一次也可能根本没送达至少分发一次当为时可以保证消息至少送达一次通过简单的机制来保证发送者发布消息并等待接收者的报文的应答在规定的时间内没有收到的应答发布者会将消息的置为并重发消息接收者接收到为的消息时应该回应报文可能因为网络延迟等原因没有及时发出这时接收者可能会多次接受同一个消息无论标志如何接收者都会将收到的消息当作一个新的消息并发送报文应答核心就是发送消息的时候接受者需要确认一次规定时间内没有确认就会重新发如果使用这种方式写业务的时候需要保证幂等性只分发一次当为时发布者和订阅者通过两次会话来保证消息只被传递一次这是最高等级的服务质量消息丢失和重复都是不可接受的使用这个服务质量等级会有额外的开销发送者发布为的消息之后消息储存起来并等待接收者回复的消息接收者收到一条为的消息时他会处理此消息并返回一条进行应答发送者收到消息后丢弃掉之前的发布消息保存消息并应答一个等待接收者回复消息接收者当接收者收到消息之后它会丢弃掉所有已保存的状态并回复发送者当发送者收到消息之后会清空之前所保存的状态核心发送消息的时候接受者需要确认两次来保证消息确实已经送到无论在传输过程中何时出现丢包发送端都负责重发上一条消息不管发送端是发送端还是服务器都是如此因此接收端也需要对每一条命令消息都进行应答在发布与订阅中的区别发布时的表示消息发送到服务端时使用的订阅时的表示服务端向自己转发消息时可以使用的最大客户端的发布大于客户端的订阅时服务端向客户端转发消息时使用的为客户端的订阅客户端的发布小于客户端的订阅时服务端向客户端转发消息时使用的为客户端的发布总结接收端可以设置订阅为这样就可以接所有等级消息也就是发布消息为多少那我这边接受消息就是多少主要以发布消息的为准如何选择等级级别越高流程越复杂系统资源消耗越大应用程序可以根据自己的网络场景和业务需求选择合适的级别以下情况下可以选择可以接受消息偶尔丢失在同一个子网内部的服务间的消息交互或其他客户端与服务端网络非常稳定的场景以下情况下可以选择对系统资源消耗较为关注希望性能最优化消息不能丢失但能接受并处理重复的消息以下情况下可以选择不能忍受消息丢失消息的丢失会造成生命或财产的损失且不希望收到重复的消息数据完整性与及时性要求较高的银行消防航空等行业清除会话客户端向服务器发起请求时可以通过标志设置是否创建全新的会话设置为时如果存在一个关联此客户标识符的会话服务端必须基于此会话的状态恢复与客户端的通信如果不存在任何关联此客户标识符的会话服务端必须创建一个新的会话设置为时客户端和服务端必须丢弃任何已存在的会话并开始一个新的会话总结监听端建议设置为一般监听端我们都会配置单例并且项目启动就开始创建连接监听设置为这样可以保证连接的唯一性和消息的安全性保活心跳客户端向服务器发起请求时通过参数设置保活周期客户端在无报文发送时按周期定时发送字节的心跳报文服务端收到报文后回复字节的报文服务端在个心跳周期内既没有收到客户端发布订阅报文也没有收到心跳报文时将断开客户端连接保留消息客户端向服务器发布消息时可以设置保留消息标志保留消息会驻留在消息服务器后来的订阅者订阅主题时可以接收到最新一条注意是只有最近的一条保留消息遗嘱消息客户端向服务端发送请求时可以携带遗嘱消息客户端异常下线时客户端断开前未向服务器发送消息消息服务器会发布遗嘱消息在连接的时候通过调用实例的方法来设定任何订阅了下面的主题的客户端都可以收到该遗嘱消息方法方法以下情况下会发送服务端发生了错误或者网络失败客户端在定义的心跳时期失联客户端在发送下线包之前关闭网络连接服务端在收到下线包之前关闭网络连接总结发送遗嘱信息可以理解为创建客户端连接的时候告诉服务器服务器我挂了之后给哪些主题发这些消息当订阅到遗嘱消息之后他就知道监听端挂了我不能给他发消息了遗嘱消息在客户端正常调用方法之后并不会被发送高级使用场景这里介绍一下如何将保留消息与遗嘱消息结合起来进行使用客户端遗嘱消息设定为该遗嘱主题与一个普通发送状态的主题设定成同一个当客户端连接时向主题发送的消息其它客户端订阅主题的时候获取消息为当客户端异常断开时系统自动向主题发送的消息其它订阅了此主题的客户端会马上收到消息如果遗嘱消息被设定了的话这时有新的订阅主题的客户端上线的时候获取到的消息为官网简介通过开放标准的物联网协议将数以亿计的物联网设备可靠地连接到通过和基于证书的认证确保安全的双向通信在该模型中提供的服务不仅为设备与设备设备与应用间架起桥梁同时可将需要的数据进行持久化以便非实时应用在后续对获取的数据加以利用优势协议支持完整支持与协议版本是全球首个支持的公有云服务支持服务完整支持与级别消息多种协议接入支持包含私有协议在内的多种通信协议接入覆盖各类行业应用可根据您的特殊使用场景定制私有化功能充分契合业务需求容量预估与伸缩通过连接数与消息吞吐量自动预估容量通过紧密的监控来制定伸缩计划集群大小可随业务规模平滑调整和对比是基于高并发的语言平台开发支持百万级连接分布式集群架构发布订阅模式的开源消息服务器开源至今在全球物联网市场得到了广泛应用在开源版基础上还陆续发展了商业版和提供云版本支持很多插件具有强大拓展能力用户依靠插件可以实现更多的功能是实现了高级消息队列协议的开源消息代理软件亦称面向消息的中间件服务器也是基于语言开发的现在可以通过插件配置的形式使其支持协议测试场景以下的测试均使用了的消息当发送的消息时这些消息每次都要作为可持久化的备份保存在硬盘上所以队列空间的使用也尤为重要这次评测使用了一个云主机的实例每个消息服务器集群由个节点组成每个节点的配置是双核内存需要强调的是我们对于和的测试使用了完全一致的硬件资源以消除变量压力测试将会有两个场景多对一和一对多多对一许多设备作为发布者如温度传感器或者是压力传感器发送数据给一个服务器服务器再将这些数据发送给一个控制器即订阅者处理这些数据一对多一个控制器作为发布者将消息传送给服务器再由服务器将这些消息传送给多个作为订阅者的设备在每个场景里多的那一方的数量将会从个逐渐上升到个每个场景里每一秒会发送一条载荷为字节的消息这样的发布并不会造成过大的吞吐量仅仅使用字节载荷是为了展示出这两个服务器的工作原理以及他们的集群模式如何对这些场景作出反应的测试结果左侧轴是指占用底部轴是指多侧的客户端数量变化多对一从多对一的结果可以看出和相比并没有太大差别一对多但是从一对多的结果来看相比于确实有很明显的差距测试总结结果表明在多对一场景中和相比并没有太大差别而在一对多场景中则较产生了较为明显的差距相比较而言使用协议和使用协议存在着一定的差距注意使用的发布订阅模型不能满足使用要求可以选择使用客户端是用编写的客户端库用于开发在或其他兼容平台例如上运行的应用程序不仅可以对接还可以对接满足符合协议规范的消息代理服务端目前可以支持到以下版本协议版本基本能满足百分之九十多的接入场景整合是消息服务器而我们想要发送消息和订阅消息都是和服务器打交道想要和服务器打交道就需要想办法连上他这时候就需要用到了客户端用来在当中连接消息服务器下面案例是按照我的应用场景来写的监听单独用了一个客户端存入了内存使用了变量启动项目的时候初始化发送客户端并没有存入内存而是发送一条创建一个客户端这里有一点需要注意客户端一定不要重复就是对于服务器来说一定要保持唯一导入依赖版本配置文件报错问题配置文件配置信息用户名密码连接地址客户端同一台服务器下不允许出现重复的客户端默认连接主题以结尾表示订阅所有以开头的主题默认服务器发送主题前缀格式超时时间设置会话心跳时间单位为秒服务器会每隔秒的时间向客户端发送个消息判断客户端是否在线但这个方法并没有重连的机制设置是否清空这里如果设置为表示服务器会保留客户端的连接记录这里设置为表示每次连接到服务器都以新的身份连接是否断线重连启动的时候是否关闭连接方式获取默认主题以结尾表示订阅所有以开头的主题获取服务器发送主题格式添加接受服务的客户端接受服务的客户端客户端连接设置回调重新连接订阅某个主题主题连接方式开始订阅主题取消订阅某个主题取消订阅主题添加接受服务的回调类接受服务的回调类客户端断开后触发连接断开可以重连重新连接客户端收到消息触发主题消息接收消息主题接收消息接收消息内容发布消息成功向主题发送消息成功消息内容连接服务器后触发客户端连接成功以结尾表示订阅所有以开头的主题订阅所有机构主题添加发送客户端发送客户端设置回调发布消息是否保留主题格式消息内容关闭连接释放资源添加发送客户端的回调类发送客户端的回调类客户端断开后触发连接断开可以重连客户端收到消息触发主题消息接收消息主题接收消息接收消息内容发布消息成功向主题发送消息成功消息内容连接服务器后触发客户端连接成功添加配置类自定义配置通过这个配置来控制启动项目的时候是否启动自定义配置通过这个配置来控制启动项目的时候是否启动能获取到使用的获取类加载器获取当前环境信息启动服务的时候开启监听客户端启动服务的时候开启监听客户端订阅测试类测试类发送和接收消息测试发送消息访问接收消息可能出现的问题问题循环引用解决方法打开循环引用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-26 15:40:52',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/icon/Morty-white.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">SherlockerSun</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 游戏页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tools/"><i class="anzhiyufont anzhiyu-icon-cube faa-tada" style="font-size: 0.9em;"></i><span> 工具箱</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>1</sup></a><a href="/tags/JVM/" style="font-size: 1.05rem;">JVM<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>4</sup></a><a href="/tags/Oracle/" style="font-size: 1.05rem;">Oracle<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 1.05rem;">SQL<sup>1</sup></a><a href="/tags/SpringBoot/" style="font-size: 1.05rem;">SpringBoot<sup>1</sup></a><a href="/tags/Springboot/" style="font-size: 1.05rem;">Springboot<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">工具<sup>1</sup></a><a href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" style="font-size: 1.05rem;">技术分享<sup>4</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 1.05rem;">数据库<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 1.05rem;">网络协议<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 1.05rem;">软件<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" style="font-size: 1.05rem;">面试总结<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" itemprop="url">技术分享</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Java/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Java</span></a><a class="article-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>技术分享</span></a><a class="article-meta__tags" href="/tags/Springboot/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Springboot</span></a><a class="article-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>网络协议</span></a></span></div></div><h1 class="post-title" itemprop="name headline">SpringBoot整合EMQX（MQTT协议）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-07-25T05:11:48.000Z" title="发表于 2024-07-25 13:11:48">2024-07-25</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-07-26T07:40:52.973Z" title="更新于 2024-07-26 15:40:52">2024-07-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为杭州"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>杭州</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/default_cover.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" itemprop="url">技术分享</a><a href="/tags/Java/" tabindex="-1" itemprop="url">Java</a><a href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" tabindex="-1" itemprop="url">技术分享</a><a href="/tags/Springboot/" tabindex="-1" itemprop="url">Springboot</a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" tabindex="-1" itemprop="url">网络协议</a><h1 id="CrawlerTitle" itemprop="name headline">SpringBoot整合EMQX（MQTT协议）</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">SherlockerSun</span><time itemprop="dateCreated datePublished" datetime="2024-07-25T05:11:48.000Z" title="发表于 2024-07-25 13:11:48">2024-07-25</time><time itemprop="dateCreated datePublished" datetime="2024-07-26T07:40:52.973Z" title="更新于 2024-07-26 15:40:52">2024-07-26</time></header><meta name="referrer" content="no-referrer"/>

<h1 id="SpringBoot整合EMQX（MQTT协议）"><a href="#SpringBoot整合EMQX（MQTT协议）" class="headerlink" title="SpringBoot整合EMQX（MQTT协议）"></a>SpringBoot整合EMQX（MQTT协议）</h1><blockquote>
<p>原文：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43888891/article/details/121880848">springboot当中使用EMQX（MQTT协议）</a></p>
</blockquote>
<h2 id="1、MQTT协议"><a href="#1、MQTT协议" class="headerlink" title="1、MQTT协议"></a>1、MQTT协议</h2><h3 id="1-1、MQTT简介"><a href="#1-1、MQTT简介" class="headerlink" title="1.1、MQTT简介"></a>1.1、MQTT简介</h3><p>MQTT 全称为 Message Queuing Telemetry Transport（消息队列遥测传输），是一种基于 发布&#x2F;订阅 模式的 轻量级物联网消息传输协议。IBM 公司的<code>安迪·斯坦福-克拉克</code>及 Arcom 公司的<code>阿兰·尼普</code>于 <code>1999</code> 年撰写了该协议的第一个版本1，之后 MQTT 便以简单易实现、支持 QoS、轻量且省带宽等众多特性逐渐成为了 IoT 通讯的标准。</p>
<p>MQTT 协议每个消息最少仅需 2 个字节 （其中报头仅需 1 个字节，其余字节可以全部作为消息载荷）就可以完成通信，专为那些资源和空间有限、功耗敏感的硬件所打造。</p>
<h3 id="1-2、MQTT-协议基本特点"><a href="#1-2、MQTT-协议基本特点" class="headerlink" title="1.2、MQTT 协议基本特点"></a>1.2、MQTT 协议基本特点</h3><ol>
<li>使用发布&#x2F;订阅消息模式，提供了一对多的消息分发和应用程序的解耦。</li>
<li>不关心负载内容的消息传输。</li>
<li>提供 3 种消息服务质量等级，满足不同投递需求。</li>
<li>很小的传输消耗和协议数据交换，最大限度减少网络流量。</li>
<li>提供连接异常断开时通知相关各方的机制。</li>
</ol>
<h3 id="1-3、MQTT-应用行业"><a href="#1-3、MQTT-应用行业" class="headerlink" title="1.3、MQTT 应用行业"></a>1.3、MQTT 应用行业</h3><p>MQTT 作为一种低开销，低带宽占用的即时通讯协议，可以用极少的代码和带宽为联网设备提供实时可靠的消息服务，它适用于硬件资源有限的设备及带宽有限的网络环境。因此，MQTT 协议广泛应用于物联网、移动互联网、智能硬件、车联网、电力能源等行业。</p>
<h3 id="1-4、MQTT-协议原理"><a href="#1-4、MQTT-协议原理" class="headerlink" title="1.4、MQTT 协议原理"></a>1.4、MQTT 协议原理</h3><p>基于发布&#x2F;订阅模式的 MQTT 协议中有三种角色：<code>发布者（Publisher）</code>、<code>代理（Broker）</code>、<code>订阅者（Subscriber）</code>。发布者向代理发布消息，代理向订阅者转发这些消息。通常情况下，客户端的角色是发布者和订阅者，服务器的角色是代理，但实际上，服务器也可能主动发布消息或者订阅主题，客串一下客户端的角色。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/7627ec7a599f58f117924bfd291caeb9.png" alt="MQTT 协议原理"></p>
<p>为了方便理解，MQTT 传输的消息可以简化为：<code>主题（Topic）</code>和<code>载荷（Payload）</code>两部分：</p>
<ul>
<li><strong>Topic</strong>，消息主题，订阅者向代理订阅主题后，一旦代理收到相应主题的消息，就会向订阅者转发该消息。</li>
<li><strong>Payload</strong>，消息载荷（也可以理解为传输的数据），订阅者在消息中真正关心的部分，通常是业务相关的。</li>
</ul>
<h3 id="1-5、MQTT-协议基础概念"><a href="#1-5、MQTT-协议基础概念" class="headerlink" title="1.5、MQTT 协议基础概念"></a>1.5、MQTT 协议基础概念</h3><h4 id="1-5-1、会话（Session）"><a href="#1-5-1、会话（Session）" class="headerlink" title="1.5.1、会话（Session）"></a>1.5.1、会话（Session）</h4><p>每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。会话可以存在于一个网络连接之间，也可以跨越多个连续的网络连接存在。</p>
<h4 id="1-5-2、订阅（Subscription）"><a href="#1-5-2、订阅（Subscription）" class="headerlink" title="1.5.2、订阅（Subscription）"></a>1.5.2、订阅（Subscription）</h4><p>订阅包含一个主题过滤器（Topic Filter）和一个最大的服务质量（QoS）等级。订阅与单个会话（Session）关联。会话可以包含多于一个的订阅。</p>
<h4 id="1-5-3、主题名（Topic-Name）"><a href="#1-5-3、主题名（Topic-Name）" class="headerlink" title="1.5.3、主题名（Topic Name）"></a>1.5.3、主题名（Topic Name）</h4><p>附加在应用消息上的一个标签，被用于匹配服务端已存在的订阅。服务端会向所有匹配订阅的客户端发送此应用消息。</p>
<h4 id="1-5-4、主题过滤器（Topic-Filter）"><a href="#1-5-4、主题过滤器（Topic-Filter）" class="headerlink" title="1.5.4、主题过滤器（Topic Filter）"></a>1.5.4、主题过滤器（Topic Filter）</h4><p>仅在订阅时使用的主题表达式，可以包含通配符，以匹配多个主题名。就是可以通过通配符达到，发一条消息，多个主题能接受到消息的效果。</p>
<h4 id="1-5-5、载荷（Payload）"><a href="#1-5-5、载荷（Payload）" class="headerlink" title="1.5.5、载荷（Payload）"></a>1.5.5、载荷（Payload）</h4><p>对于 PUBLISH 报文来说载荷就是业务消息（就是指发送的消息内容），它可以是任意格式（二进制、十六进制、普通字符串、JSON 字符串、Base64）的数据。</p>
<h3 id="1-6、MQTT-协议进阶"><a href="#1-6、MQTT-协议进阶" class="headerlink" title="1.6、MQTT 协议进阶"></a>1.6、MQTT 协议进阶</h3><h4 id="1-6-1、消息服务质量（QoS）"><a href="#1-6-1、消息服务质量（QoS）" class="headerlink" title="1.6.1、消息服务质量（QoS）"></a>1.6.1、消息服务质量（QoS）</h4><p>MQTT 协议提供了 3 种消息服务质量等级（Quality of Service），它保证了在不同的网络环境下消息传递的可靠性。这里有一点要明白，<strong>必须先订阅，发布消息才会收到</strong>。假如没订阅，他发送消息了，我再订阅，这时候不管QoS设置几，都是收不到消息的。</p>
<ol>
<li><h5 id="QoS-0（最多分发一次）"><a href="#QoS-0（最多分发一次）" class="headerlink" title="QoS 0（最多分发一次）"></a>QoS 0（最多分发一次）</h5><p>当 QoS 为 0 时，消息的分发依赖于底层网络的能力。发布者只会发布一次消息，接收者不会应答消息，发布者也不会储存和重发消息。消息在这个等级下具有最高的传输效率，但可能送达一次也可能根本没送达。</p>
</li>
<li><p><strong>Qos 1（至少分发一次）</strong></p>
<p>当 QoS 为 1 时，可以保证消息至少送达一次。MQTT 通过简单的 ACK 机制来保证 QoS 1。</p>
<ul>
<li><strong>发送者：</strong> 发布消息，并等待接收者的 PUBACK 报文的应答，在规定的时间内没有收到 PUBACK 的应答，发布者会将消息的 DUP 置为1 并重发消息。</li>
<li><strong>接收者：</strong> 接收到 QoS 为 1 的消息时应该回应 PUBACK 报文，可能因为网络延迟等原因没有及时发出，这时接收者可能会多次接受同一个消息，无论 DUP标志如何，接收者都会将收到的消息当作一个新的消息并发送 PUBACK 报文应答。</li>
</ul>
<p>**核心：就是发送消息的时候，接受者需要确认一次，规定时间内没有确认就会重新发。如果使用这种方式，写业务的时候需要保证<code>幂等性</code>**。</p>
</li>
<li><p><strong>QoS 2（只分发一次）</strong></p>
<p>当 QoS 为 2 时，发布者和订阅者通过两次会话来保证消息只被传递一次，这是最高等级的服务质量，消息丢失和重复都是不可接受的。使用这个服务质量等级会有额外的开销。</p>
<ul>
<li><strong>发送者：</strong> 发布 QoS 为 2 的消息之后，消息储存起来并等待接收者回复 PUBREC 的消息。</li>
<li><strong>接收者：</strong> 收到一条 QoS 为 2 的消息时，他会处理此消息并返回一条 PUBREC 进行应答。</li>
<li><strong>发送者：</strong> 收到 PUBREC 消息后，丢弃掉之前的发布消息。保存 PUBREC 消息，并应答一个 PUBREL。等待接收者回复 PUBCOMP 消息</li>
<li><strong>接收者：</strong> 当接收者收到 PUBREL 消息之后，它会丢弃掉所有已保存的状态，并回复 PUBCOMP。</li>
<li><strong>发送者：</strong> 当发送者收到 PUBCOMP 消息之后会清空之前所保存的状态。</li>
</ul>
<p><strong>核心：发送消息的时候，接受者需要确认两次，来保证消息确实已经送到。</strong></p>
<p>无论在传输过程中何时出现丢包，发送端都负责重发上一条消息。不管发送端是 Publisher（发送端） 还是 Broker（服务器），都是如此。因此，接收端也需要对每一条命令消息都进行应答。</p>
</li>
</ol>
<h4 id="1-6-2、QoS-在发布与订阅中的区别"><a href="#1-6-2、QoS-在发布与订阅中的区别" class="headerlink" title="1.6.2、QoS 在发布与订阅中的区别"></a>1.6.2、QoS 在发布与订阅中的区别</h4><p>发布时的 QoS 表示消息发送到服务端时使用的 QoS<br>订阅时的 QoS 表示服务端向自己转发消息时可以使用的最大 QoS</p>
<ul>
<li>客户端 A 的发布 QoS 大于客户端 B 的订阅 QoS 时，服务端向客户端 B 转发消息时使用的 QoS 为客户端 B 的订阅QoS。</li>
<li>客户端 A 的发布 QoS 小于客户端 B 的订阅 QoS 时，服务端向客户端 B 转发消息时使用的 QoS 为客户端 A 的发布 QoS。</li>
</ul>
<p><strong>总结：接收端可以设置订阅Qos为2，这样就可以接所有qos等级消息。也就是发布消息qos为多少，那我这边接受消息就是多少。主要以发布消息的qos为准。</strong></p>
<h4 id="1-6-3、如何选择-MQTT-QoS-等级"><a href="#1-6-3、如何选择-MQTT-QoS-等级" class="headerlink" title="1.6.3、如何选择 MQTT QoS 等级"></a>1.6.3、如何选择 MQTT QoS 等级</h4><p><strong>QoS 级别越高，流程越复杂，系统资源消耗越大。</strong> 应用程序可以根据自己的网络场景和业务需求，选择合适的 QoS 级别。</p>
<ol>
<li><p>以下情况下可以选择 <strong>QoS 0</strong></p>
<ul>
<li><p>可以接受消息偶尔丢失。</p>
</li>
<li><p>在同一个子网内部的服务间的消息交互，或其他客户端与服务端 网络非常稳定的场景。</p>
</li>
</ul>
</li>
<li><p>以下情况下可以选择 <strong>QoS 1</strong></p>
<ul>
<li><p>对系统资源消耗较为关注，希望性能最优化。</p>
</li>
<li><p>消息不能丢失，但能接受并处理重复的消息。</p>
</li>
</ul>
</li>
<li><p>以下情况下可以选择 <strong>QoS 2</strong></p>
<ul>
<li><p>不能忍受消息丢失（消息的丢失会造成生命或财产的损失），且不希望收到重复的消息。</p>
</li>
<li><p>数据完整性与及时性要求较高的银行、消防、航空等行业。</p>
</li>
</ul>
</li>
</ol>
<h4 id="1-6-4、清除会话（Clean-Session）"><a href="#1-6-4、清除会话（Clean-Session）" class="headerlink" title="1.6.4、清除会话（Clean Session）"></a>1.6.4、清除会话（Clean Session）</h4><p>MQTT 客户端向服务器发起 CONNECT 请求时，可以通过 Clean Session 标志设置是否创建全新的会话。</p>
<ol>
<li>Clean Session 设置为 <strong>0</strong> 时：<ul>
<li>如果存在一个关联此客户标识符的会话，服务端必须基于此会话的状态恢复与客户端的通信。</li>
<li>如果不存在任何关联此客户标识符的会话，服务端必须创建一个新的会话。</li>
</ul>
</li>
<li>Clean Session 设置为 <strong>1</strong> 时：<ul>
<li>客户端和服务端必须丢弃任何已存在的会话，并开始一个新的会话。</li>
</ul>
</li>
</ol>
<p><strong>总结：监听端建议设置为0，一般监听端，我们都会配置单例，并且项目启动就开始创建连接监听，设置为0，这样可以保证连接的唯一性，和消息的安全性。</strong></p>
<h4 id="1-6-5、保活心跳（Keep-Alive）"><a href="#1-6-5、保活心跳（Keep-Alive）" class="headerlink" title="1.6.5、保活心跳（Keep Alive）"></a>1.6.5、保活心跳（Keep Alive）</h4><p>MQTT 客户端向服务器发起 CONNECT 请求时，通过 Keep Alive 参数设置保活周期。</p>
<p>客户端在无报文发送时，按 Keep Alive 周期定时发送 2 字节的 PINGREQ 心跳报文，服务端收到 PINGREQ 报文后，回复 2 字节的 PINGRESP 报文。</p>
<p>服务端在 1.5 个心跳周期内，既没有收到客户端发布订阅报文，也没有收到 PINGREQ 心跳报文时，将断开客户端连接。</p>
<h4 id="1-6-6、保留消息（Retained-Message）"><a href="#1-6-6、保留消息（Retained-Message）" class="headerlink" title="1.6.6、保留消息（Retained Message）"></a>1.6.6、保留消息（Retained Message）</h4><p>MQTT 客户端向服务器发布（PUBLISH）消息时，可以设置保留消息（Retained Message）标志。保留消息会驻留在消息服务器，后来的订阅者订阅主题时可以接收到最新<strong>一条（注意，是只有最近的一条）</strong>保留消息。</p>
<h4 id="1-6-7、遗嘱消息（Will-Message）"><a href="#1-6-7、遗嘱消息（Will-Message）" class="headerlink" title="1.6.7、遗嘱消息（Will Message）"></a>1.6.7、遗嘱消息（Will Message）</h4><p>MQTT 客户端向服务端发送 CONNECT 请求时，可以携带遗嘱消息。MQTT 客户端异常下线时（客户端断开前未向服务器发送 DISCONNECT 消息)，MQTT 消息服务器会发布遗嘱消息。</p>
<p>在连接的时候通过调用 MqttConnectOptions 实例的 setWill 方法来设定。任何订阅了下面的主题的客户端都可以收到该遗嘱消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方法1</span></span><br><span class="line">MqttConnectOptions.setWill(MqttTopic topic, <span class="type">byte</span>[] payload, <span class="type">int</span> qos, <span class="type">boolean</span> retained);</span><br><span class="line"><span class="comment">//方法2</span></span><br><span class="line">MqttConnectOptions.setWill(java.lang.String topic, <span class="type">byte</span>[] payload, <span class="type">int</span> qos, <span class="type">boolean</span> retained);</span><br></pre></td></tr></table></figure>

<p>以下情况下会发送 <code>Will Message</code>：</p>
<ul>
<li>服务端发生了I&#x2F;O 错误或者网络失败；</li>
<li>客户端在定义的心跳时期失联；</li>
<li>客户端在发送下线包（ DISCONNECT）之前关闭网络连接；</li>
<li>服务端在收到下线包之前关闭网络连接。</li>
</ul>
<p><strong>总结：发送遗嘱信息可以理解为，创建客户端连接的时候，告诉服务器（mqtt服务器）我挂了之后，给哪些主题发这些消息。当订阅到遗嘱消息之后，他就知道监听端挂了，我不能给他发消息了，遗嘱消息在客户端正常调用 disconnect 方法之后并不会被发送。</strong></p>
<p><strong>高级使用场景：</strong><br>这里介绍一下如何将 Retained（保留） 消息与Will （遗嘱）消息结合起来进行使用。</p>
<ol>
<li>客户端 A 遗嘱消息设定为”offline“，该遗嘱主题与一个普通发送状态的主题设定成同一个 A&#x2F;status；</li>
<li>当客户端 A 连接时，向主题 A&#x2F;status 发送 “online” 的 Retained 消息，其它客户端订阅主题 A&#x2F;status的时候，获取 Retained 消息为 “online” ；</li>
<li>当客户端 A 异常断开时，系统自动向主题 A&#x2F;status 发送”offline“的消息，其它订阅了此主题的客户端会马上收到”offline“消息；如果遗嘱消息被设定了 Retained 的话，这时有新的订阅A&#x2F;status主题的客户端上线的时候，获取到的消息为“offline”。</li>
</ol>
<h2 id="2、EMQ-X-Cloud"><a href="#2、EMQ-X-Cloud" class="headerlink" title="2、EMQ X Cloud"></a>2、EMQ X Cloud</h2><blockquote>
<p>官网：<a target="_blank" rel="noopener" href="https://www.emqx.com/zh/cloud">https://www.emqx.com/zh/cloud</a></p>
</blockquote>
<h3 id="2-1、EMQ-X-Cloud简介"><a href="#2-1、EMQ-X-Cloud简介" class="headerlink" title="2.1、EMQ X Cloud简介"></a>2.1、EMQ X Cloud简介</h3><p>通过开放标准的物联网协议 MQTT、MQTT over WebSocket、CoAP&#x2F;LwM2M 将数以亿计的物联网设备可靠地连接到 EMQ X Cloud。通过 TLS&#x2F;SSL 和基于 X.509 证书的认证确保安全的双向通信。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/4e0a6a5ae120ee86beac43be31f659d1.png" alt="EMQ X Cloud模型"></p>
<p>在该模型中，EMQ X Cloud 提供的 MQTT 服务不仅为设备与设备、设备与应用间架起桥梁，同时可将需要的数据进行持久化，以便非实时应用在后续对获取的数据加以利用。</p>
<h3 id="2-2、EMQ-X-Cloud优势"><a href="#2-2、EMQ-X-Cloud优势" class="headerlink" title="2.2、EMQ X Cloud优势"></a>2.2、EMQ X Cloud优势</h3><h4 id="2-2-1、协议支持完整"><a href="#2-2-1、协议支持完整" class="headerlink" title="2.2.1、协议支持完整"></a>2.2.1、协议支持完整</h4><p>支持 MQTT v3.1，v3.1.1 与 v5.0 协议版本，是全球首个支持 MQTT 5.0 的公有云服务，支持 MQTT WebSocket 服务，完整支持 QoS0, QoS1 与 QoS2 级别 MQTT 消息。</p>
<h4 id="2-2-2、多种协议接入"><a href="#2-2-2、多种协议接入" class="headerlink" title="2.2.2、多种协议接入"></a>2.2.2、多种协议接入</h4><p>支持包含 MQTT、MQTT-SN、CoAP、LwM2M、私有 TCP 协议在内的多种通信协议接入，覆盖各类行业应用；可根据您的特殊使用场景定制私有化功能，充分契合业务需求。</p>
<h4 id="2-2-3、容量预估与伸缩"><a href="#2-2-3、容量预估与伸缩" class="headerlink" title="2.2.3、容量预估与伸缩"></a>2.2.3、容量预估与伸缩</h4><p>通过连接数与消息吞吐量自动预估容量，通过紧密的监控来制定伸缩计划，集群大小可随业务规模平滑调整。</p>
<h3 id="2-3、EMQ-X-和-RabbitMQ对比"><a href="#2-3、EMQ-X-和-RabbitMQ对比" class="headerlink" title="2.3、EMQ X 和 RabbitMQ对比"></a>2.3、EMQ X 和 RabbitMQ对比</h3><p>EMQ X 是基于高并发的 Erlang&#x2F;OTP 语言平台开发，支持百万级连接、分布式集群架构、发布订阅模式的开源 MQTT 消息服务器。开源至今，EMQ X 在全球物联网市场得到了广泛应用。在开源版基础上，还陆续发展了商业版和提供云版本（cloud-hosting）。EMQ X 支持很多插件，具有强大拓展能力，用户依靠插件可以实现更多的功能。</p>
<p>RabbitMQ 是实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件）。RabbitMQ 服务器也是基于 Erlang 语言开发的，现在可以通过插件配置的形式，使其支持 MQTT 协议。</p>
<h4 id="2-3-1、测试场景"><a href="#2-3-1、测试场景" class="headerlink" title="2.3.1、测试场景"></a>2.3.1、测试场景</h4><p>以下的测试均使用了 QoS 1 的消息。当发送 QoS 1 的消息时，这些消息每次都要作为可持久化的备份保存在硬盘上。所以队列空间的使用也尤为重要。</p>
<p>这次评测使用了一个云主机 M5 large 的实例，每个 MQTT 消息服务器集群由 3 个节点组成，每个节点的配置是双核，8GB 内存。需要强调的是，我们对于 EMQ X 和 RabbitMQ 的测试使用了完全一致的硬件资源以消除变量。</p>
<p>压力测试将会有两个场景，<strong>「多对一」</strong> 和 <strong>「一对多」</strong>。</p>
<h5 id="1-多对一"><a href="#1-多对一" class="headerlink" title="1.多对一"></a>1.多对一</h5><p>许多设备作为发布者，如温度传感器或者是压力传感器，发送数据给一个服务器。服务器再将这些数据发送给一个控制器（即订阅者）处理这些数据。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/63227dacea9dcc17179af7818b92c82c.png" alt="多对一"></p>
<h5 id="2-一对多"><a href="#2-一对多" class="headerlink" title="2.一对多"></a>2.一对多</h5><p>一个控制器作为发布者将消息传送给服务器，再由服务器将这些消息传送给多个作为订阅者的设备。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/7c48551d16a0a880bc1b88611fefc9ab.png" alt="一对多"></p>
<p>在每个场景里，「多」的那一方的数量将会从 2000 个逐渐上升到 10000 个。每个场景里，每一秒会发送一条载荷为 256 字节的消息。这样的发布并不会造成过大的吞吐量。仅仅使用 256 字节载荷是为了展示出这两个服务器的工作原理，以及他们的集群模式如何对这些场景作出反应的。</p>
<h4 id="2-3-2、测试结果"><a href="#2-3-2、测试结果" class="headerlink" title="2.3.2、测试结果"></a>2.3.2、测试结果</h4><p>左侧Y轴是指 CPU 占用，底部X轴是指「多」侧的客户端数量变化。</p>
<h5 id="1-多对一-1"><a href="#1-多对一-1" class="headerlink" title="1.多对一"></a>1.多对一</h5><p>从 「多对一」 的结果可以看出，EMQ X 和 RabbitMQ 相比并没有太大差别。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/2b19ffedf45b7d9eb09764916d921513.png" alt="多对一测试结果"></p>
<h5 id="2-一对多-1"><a href="#2-一对多-1" class="headerlink" title="2.一对多"></a>2.一对多</h5><p>但是从「一对多」的结果来看，RabbitMQ 相比于 EMQ X 确实有很明显的差距。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/04f1426e4ea489a79916ad8c2e348e45.png" alt="一对多测试结果"></p>
<h4 id="2-3-3、测试总结"><a href="#2-3-3、测试总结" class="headerlink" title="2.3.3、测试总结"></a>2.3.3、测试总结</h4><p>结果表明：在「多对一」 场景中，EMQ X 和 RabbitMQ 相比并没有太大差别；而在「一对多」场景中，RabbitMQ 则较 EMQ X 产生了较为明显的差距。相比较而言，RabbitMQ使用MQTT协议，和 EMQ X使用MQTT协议存在着一定的差距。</p>
<h4 id="2-3-4、注意"><a href="#2-3-4、注意" class="headerlink" title="2.3.4、注意"></a>2.3.4、注意</h4><p>使用MQTT的发布－订阅模型不能满足使用要求。可以选择使用AMQP。</p>
<h2 id="3、Eclipse-Paho-Java"><a href="#3、Eclipse-Paho-Java" class="headerlink" title="3、Eclipse Paho Java"></a>3、Eclipse Paho Java</h2><p>Paho Java客户端是用Java编写的MQTT客户端库，用于开发在JVM或其他Java兼容平台（例如Android）上运行的应用程序。<br>Paho不仅可以对接EMQ X Broker，还可以对接满足符合MQTT协议规范的消息代理服务端，目前Paho可以支持到MQTT5.0以下版本。MQTT3.3.1协议版本基本能满足百分之九十多的接入场景。</p>
<h2 id="4、SpringBoot整合Eclipse-Paho-Java"><a href="#4、SpringBoot整合Eclipse-Paho-Java" class="headerlink" title="4、SpringBoot整合Eclipse Paho Java"></a>4、SpringBoot整合Eclipse Paho Java</h2><p>EMQX是消息服务器，而我们java想要发送消息，和订阅消息都是和服务器打交道，想要和服务器打交道就需要想办法连上他，这时候就需要用到了Eclipse Paho Java客户端，用来在java当中连接EMQX消息服务器。</p>
<p>下面案例是按照我的应用场景来写的，监听单独用了一个客户端存入了内存，使用了static变量，启动项目的时候初始化，发送客户端并没有存入内存，而是发送一条，创建一个客户端。这里有一点需要注意，客户端id一定不要重复，就是对于MQTT服务器来说，clientId一定要保持唯一。</p>
<h3 id="4-1、导入Maven依赖"><a href="#4-1、导入Maven依赖" class="headerlink" title="4.1、导入Maven依赖"></a>4.1、导入Maven依赖</h3><p><code>SpringBoot版本：2.3.9.RELEASE</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mqtt --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-integration<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.integration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-integration-stream<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.integration<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-integration-mqtt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置文件报错问题--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2、配置文件"><a href="#4-2、配置文件" class="headerlink" title="4.2、配置文件"></a>4.2、配置文件</h3><h4 id="4-2-1、application-yml"><a href="#4-2-1、application-yml" class="headerlink" title="4.2.1、application.yml"></a>4.2.1、application.yml</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mqtt:</span></span><br><span class="line">  <span class="attr">hostUrl:</span> <span class="string">tcp://192.168.56.103:1883</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">client-id:</span> <span class="string">MQTT-CLIENT-DEV</span></span><br><span class="line">  <span class="attr">cleanSession:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">reconnect:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">keepAlive:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">defaultTopic:</span> <span class="string">client/dev/report</span></span><br><span class="line">  <span class="attr">serverTopic:</span> <span class="string">server/dev/report</span></span><br><span class="line">  <span class="attr">isOpen:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">qos:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-2、MqttProperties"><a href="#4-2-2、MqttProperties" class="headerlink" title="4.2.2、MqttProperties"></a>4.2.2、MqttProperties</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : MQTT配置信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(&quot;mqtt&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  hostUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端Id，同一台服务器下，不允许出现重复的客户端id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  clientId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认连接主题，以/#结尾表示订阅所有以test开头的主题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  defaultTopic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认服务器发送主题前缀，格式：server:$&#123;env&#125;:report:$&#123;topic&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String  serverTopic;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 超时时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>     timeout;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置会话心跳时间 单位为秒 服务器会每隔1.5*20秒的时间向客户端</span></span><br><span class="line"><span class="comment">     * 发送个消息判断客户端是否在线，但这个方法并没有重连的机制</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>     keepAlive;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置是否清空session,这里如果设置为false表示服务器会保留客户端的连</span></span><br><span class="line"><span class="comment">     * 接记录，这里设置为true表示每次连接到服务器都以新的身份连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean cleanSession;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否断线重连</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean reconnect;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动的时候是否关闭mqtt</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Boolean isOpen;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer qos;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取默认主题，以/#结尾表示订阅所有以test开头的主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDefaultTopic</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultTopic + <span class="string">&quot;/#&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务器发送主题，格式：server/$&#123;env&#125;/report/$&#123;topic&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServerTopic</span><span class="params">(String topic)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> serverTopic + <span class="string">&quot;/&quot;</span> + topic;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3、添加MQTT接受服务的客户端"><a href="#4-3、添加MQTT接受服务的客户端" class="headerlink" title="4.3、添加MQTT接受服务的客户端"></a>4.3、添加MQTT接受服务的客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttClient;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttConnectOptions;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttException;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : MQTT接受服务的客户端</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttAcceptClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MqttAcceptClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttAcceptCallback  mqttAcceptCallback;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttProperties      mqttProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MqttClient    client;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MqttClient <span class="title function_">getClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setClient</span><span class="params">(MqttClient client)</span> &#123;</span><br><span class="line">        MqttAcceptClient.client = client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">()</span> &#123;</span><br><span class="line">        MqttClient client;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client = <span class="keyword">new</span> <span class="title class_">MqttClient</span>(mqttProperties.getHostUrl(), mqttProperties.getClientId(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">MemoryPersistence</span>());</span><br><span class="line">            <span class="type">MqttConnectOptions</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MqttConnectOptions</span>();</span><br><span class="line">            options.setUserName(mqttProperties.getUsername());</span><br><span class="line">            options.setPassword(mqttProperties.getPassword().toCharArray());</span><br><span class="line">            options.setConnectionTimeout(mqttProperties.getTimeout());</span><br><span class="line">            options.setKeepAliveInterval(mqttProperties.getKeepAlive());</span><br><span class="line">            options.setAutomaticReconnect(mqttProperties.getReconnect());</span><br><span class="line">            options.setCleanSession(mqttProperties.getCleanSession());</span><br><span class="line">            MqttAcceptClient.setClient(client);</span><br><span class="line">            <span class="comment">// 设置回调</span></span><br><span class="line">            client.setCallback(mqttAcceptCallback);</span><br><span class="line">            client.connect(options);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttAcceptClient connect error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重新连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reconnection</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.connect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttAcceptClient reconnection error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订阅某个主题</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic 主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> qos   连接方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(String topic, <span class="type">int</span> qos)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;========================【开始订阅主题:&quot;</span> + topic + <span class="string">&quot;】========================&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.subscribe(topic, qos);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttAcceptClient subscribe error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消订阅某个主题</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unsubscribe</span><span class="params">(String topic)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;========================【取消订阅主题:&quot;</span> + topic + <span class="string">&quot;】========================&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            client.unsubscribe(topic);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttAcceptClient unsubscribe error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4、添加MQTT接受服务的回调类"><a href="#4-4、添加MQTT接受服务的回调类" class="headerlink" title="4.4、添加MQTT接受服务的回调类"></a>4.4、添加MQTT接受服务的回调类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.IMqttDeliveryToken;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttCallbackExtended;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttException;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttMessage;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : MQTT接受服务的回调类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttAcceptCallback</span> <span class="keyword">implements</span> <span class="title class_">MqttCallbackExtended</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MqttAcceptCallback.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttAcceptClient    mqttAcceptClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttProperties      mqttProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端断开后触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connectionLost</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;连接断开，可以重连&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (MqttAcceptClient.client == <span class="literal">null</span> || !MqttAcceptClient.client.isConnected()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;【emqx重新连接】....................................................&quot;</span>);</span><br><span class="line">            mqttAcceptClient.reconnection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端收到消息触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic       主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqttMessage 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">messageArrived</span><span class="params">(String topic, MqttMessage mqttMessage)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;【接收消息主题】:&quot;</span> + topic);</span><br><span class="line">        logger.info(<span class="string">&quot;【接收消息Qos】:&quot;</span> + mqttMessage.getQos());</span><br><span class="line">        logger.info(<span class="string">&quot;【接收消息内容】:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(mqttMessage.getPayload()));</span><br><span class="line">        <span class="comment">//        int i = 1/0;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布消息成功</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deliveryComplete</span><span class="params">(IMqttDeliveryToken token)</span> &#123;</span><br><span class="line">        String[] topics = token.getTopics();</span><br><span class="line">        <span class="keyword">for</span> (String topic : topics) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;向主题【&quot;</span> + topic + <span class="string">&quot;】发送消息成功！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MqttMessage</span> <span class="variable">message</span> <span class="operator">=</span> token.getMessage();</span><br><span class="line">            <span class="type">byte</span>[] payload = message.getPayload();</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(payload, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            logger.info(<span class="string">&quot;【消息内容】:&quot;</span> + s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttAcceptCallback deliveryComplete error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接emq服务器后触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connectComplete</span><span class="params">(<span class="type">boolean</span> b, String s)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;============================= 客户端【&quot;</span> + MqttAcceptClient.client.getClientId() + <span class="string">&quot;】连接成功！=============================&quot;</span>);</span><br><span class="line">        <span class="comment">// 以/#结尾表示订阅所有以test开头的主题</span></span><br><span class="line">        <span class="comment">// 订阅所有机构主题</span></span><br><span class="line">        mqttAcceptClient.subscribe(mqttProperties.getDefaultTopic(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5、添加MQTT发送客户端"><a href="#4-5、添加MQTT发送客户端" class="headerlink" title="4.5、添加MQTT发送客户端"></a>4.5、添加MQTT发送客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.*;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.persist.MemoryPersistence;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : MQTT发送客户端</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttSendClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span>       <span class="operator">=</span> LoggerFactory.getLogger(MqttSendClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttSendCallBack    mqttSendCallBack;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttProperties      mqttProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MqttClient <span class="title function_">connect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MqttClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            client = <span class="keyword">new</span> <span class="title class_">MqttClient</span>(mqttProperties.getHostUrl(), uuid, <span class="keyword">new</span> <span class="title class_">MemoryPersistence</span>());</span><br><span class="line">            <span class="type">MqttConnectOptions</span> <span class="variable">options</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MqttConnectOptions</span>();</span><br><span class="line">            options.setUserName(mqttProperties.getUsername());</span><br><span class="line">            options.setPassword(mqttProperties.getPassword().toCharArray());</span><br><span class="line">            options.setConnectionTimeout(mqttProperties.getTimeout());</span><br><span class="line">            options.setKeepAliveInterval(mqttProperties.getKeepAlive());</span><br><span class="line">            options.setCleanSession(<span class="literal">true</span>);</span><br><span class="line">            options.setAutomaticReconnect(<span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// 设置回调</span></span><br><span class="line">            client.setCallback(mqttSendCallBack);</span><br><span class="line">            client.connect(options);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttSendClient connect error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> retained 是否保留</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic 主题，格式： server:$&#123;env&#125;:report:$&#123;topic&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 消息内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(<span class="type">boolean</span> retained, String topic, String content)</span> &#123;</span><br><span class="line">        <span class="type">MqttMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MqttMessage</span>();</span><br><span class="line">        message.setQos(mqttProperties.getQos());</span><br><span class="line">        message.setRetained(retained);</span><br><span class="line">        message.setPayload(content.getBytes());</span><br><span class="line">        MqttDeliveryToken token;</span><br><span class="line">        <span class="type">MqttClient</span> <span class="variable">mqttClient</span> <span class="operator">=</span> connect();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mqttClient.publish(mqttProperties.getServerTopic(topic), message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttSendClient publish error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            disconnect(mqttClient);</span><br><span class="line">            close(mqttClient);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqttClient</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">disconnect</span><span class="params">(MqttClient mqttClient)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mqttClient != <span class="literal">null</span>)</span><br><span class="line">                mqttClient.disconnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttSendClient disconnect error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放资源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqttClient</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">(MqttClient mqttClient)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mqttClient != <span class="literal">null</span>)</span><br><span class="line">                mqttClient.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MqttException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttSendClient close error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-6、添加MQTT发送客户端的回调类"><a href="#4-6、添加MQTT发送客户端的回调类" class="headerlink" title="4.6、添加MQTT发送客户端的回调类"></a>4.6、添加MQTT发送客户端的回调类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.IMqttDeliveryToken;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttCallbackExtended;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttException;</span><br><span class="line"><span class="keyword">import</span> org.eclipse.paho.client.mqttv3.MqttMessage;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : MQTT发送客户端的回调类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttSendCallBack</span> <span class="keyword">implements</span> <span class="title class_">MqttCallbackExtended</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MqttSendCallBack.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端断开后触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connectionLost</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;连接断开，可以重连&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端收到消息触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic       主题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mqttMessage 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">messageArrived</span><span class="params">(String topic, MqttMessage mqttMessage)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;【接收消息主题】: &quot;</span> + topic);</span><br><span class="line">        logger.info(<span class="string">&quot;【接收消息Qos】: &quot;</span> + mqttMessage.getQos());</span><br><span class="line">        logger.info(<span class="string">&quot;【接收消息内容】: &quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(mqttMessage.getPayload()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布消息成功</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deliveryComplete</span><span class="params">(IMqttDeliveryToken token)</span> &#123;</span><br><span class="line">        String[] topics = token.getTopics();</span><br><span class="line">        <span class="keyword">for</span> (String topic : topics) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;向主题【&quot;</span> + topic + <span class="string">&quot;】发送消息成功！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MqttMessage</span> <span class="variable">message</span> <span class="operator">=</span> token.getMessage();</span><br><span class="line">            <span class="type">byte</span>[] payload = message.getPayload();</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(payload, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            logger.info(<span class="string">&quot;【消息内容】:&quot;</span> + s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;MqttSendCallBack deliveryComplete error,message:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接emq服务器后触发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connectComplete</span><span class="params">(<span class="type">boolean</span> b, String s)</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;============================= 客户端【&quot;</span> + MqttAcceptClient.client.getClientId() + <span class="string">&quot;】连接成功！=============================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-7、添加配置类"><a href="#4-7、添加配置类" class="headerlink" title="4.7、添加配置类"></a>4.7、添加配置类</h3><p>自定义配置,通过这个配置，来控制启动项目的时候是否启动mqtt</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Condition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.Environment;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : 自定义配置,通过这个配置，来控制启动项目的时候是否启动mqtt</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttCondition</span> <span class="keyword">implements</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata annotatedTypeMetadata)</span> &#123;</span><br><span class="line">        <span class="comment">//1、能获取到ioc使用的beanfactory</span></span><br><span class="line">        <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> context.getBeanFactory();</span><br><span class="line">        <span class="comment">//2、获取类加载器</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">        <span class="comment">//3、获取当前环境信息</span></span><br><span class="line">        <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> context.getEnvironment();</span><br><span class="line">        <span class="type">String</span> <span class="variable">isOpen</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;mqtt.isOpen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Boolean.valueOf(isOpen);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-8、启动服务的时候开启监听客户端"><a href="#4-8、启动服务的时候开启监听客户端" class="headerlink" title="4.8、启动服务的时候开启监听客户端"></a>4.8、启动服务的时候开启监听客户端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.iot.mqtt.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Conditional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : 启动服务的时候开启监听客户端</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttAcceptClient mqttAcceptClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订阅mqtt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Conditional(MqttCondition.class)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MqttAcceptClient <span class="title function_">getMqttPushClient</span><span class="params">()</span> &#123;</span><br><span class="line">        mqttAcceptClient.connect();</span><br><span class="line">        <span class="keyword">return</span> mqttAcceptClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-9、测试类"><a href="#4-9、测试类" class="headerlink" title="4.9、测试类"></a>4.9、测试类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.dreamlu.iot.mqtt.client.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.dreamlu.iot.mqtt.client.config.MqttSendClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> : 测试类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> : Sherlock</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2023/8/1 16:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/mqtt&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqttController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MqttSendClient mqttSendClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/publishTopic&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">publishTopic</span><span class="params">(String topic, String sendMessage)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;topic:&quot;</span> + topic);</span><br><span class="line">        System.out.println(<span class="string">&quot;message:&quot;</span> + sendMessage);</span><br><span class="line">        <span class="built_in">this</span>.mqttSendClient.publish(<span class="literal">false</span>, topic, sendMessage);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;topic:&quot;</span> + topic + <span class="string">&quot;\nmessage:&quot;</span> + sendMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-10、发送和接收消息测试"><a href="#4-10、发送和接收消息测试" class="headerlink" title="4.10、发送和接收消息测试"></a>4.10、发送和接收消息测试</h3><h4 id="4-10-1、发送消息"><a href="#4-10-1、发送消息" class="headerlink" title="4.10.1、发送消息"></a>4.10.1、发送消息</h4><p>访问：<code>http://localhost:8080/mqtt/publishTopic?sendMessage=222</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/91de48a566c83f5cf9b5eaf3021c11b1.png" alt="发送消息测试"></p>
<h4 id="4-10-2、接收消息"><a href="#4-10-2、接收消息" class="headerlink" title="4.10.2、接收消息"></a>4.10.2、接收消息</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/2ba2c52fe47cf7834a43eef01f24bb28.png" alt="监听消息测试"></p>
<h3 id="4-11、可能出现的问题"><a href="#4-11、可能出现的问题" class="headerlink" title="4.11、可能出现的问题"></a>4.11、可能出现的问题</h3><p><strong>问题：循环引用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">The dependencies of some of the beans in the application context form a cycle:</span><br><span class="line"></span><br><span class="line">┌─────┐</span><br><span class="line">|  mqttAcceptCallback (field private net.iot.mqtt.client.config.MqttAcceptClient net.iot.mqtt.client.config.MqttAcceptCallback.mqttAcceptClient)</span><br><span class="line">↑     ↓</span><br><span class="line">|  mqttAcceptClient (field private net.iot.mqtt.client.config.MqttAcceptCallback net.iot.mqtt.client.config.MqttAcceptClient.mqttAcceptCallback)</span><br><span class="line">└─────┘</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line"></span><br><span class="line">Relying upon circular references is discouraged and they are prohibited by default. Update your application to remove the dependency cycle between beans. As a last resort, it may be possible to break the cycle automatically by setting spring.main.allow-circular-references to true.</span><br></pre></td></tr></table></figure>

<p><strong>解决方法：打开循环引用</strong></p>
   <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">main:</span></span><br><span class="line">    <span class="attr">allow-circular-references:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/icon/Morty.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/icon/Morty.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">SherlockerSun</div><div class="post-copyright__author_desc">是可爱汉堡包啦</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/')">SpringBoot整合EMQX（MQTT协议）</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=SpringBoot整合EMQX（MQTT协议）&amp;url=http://example.com/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/&amp;pic=/img/default_cover.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">SherlockerSun</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Java/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Java<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>技术分享<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/Springboot/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Springboot<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>网络协议<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/default_cover.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/25/Oracle%E8%B0%83%E4%BC%98%E4%B9%8B%E7%9C%8B%E6%87%82Oracle%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/cover/JVM.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Oracle调优之看懂Oracle执行计划</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88Quartz/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot整合Quartz</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/07/24/JVM%E8%B0%83%E4%BC%98/" title="JVM调优"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/cover/JVM.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-24</div><div class="title">JVM调优</div></div></a></div><div><a href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88Quartz/" title="SpringBoot整合Quartz"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-25</div><div class="title">SpringBoot整合Quartz</div></div></a></div><div><a href="/2024/07/15/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" title="面试总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/cover/interview.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-15</div><div class="title">面试总结</div></div></a></div><div><a href="/2024/07/25/Oracle%E8%B0%83%E4%BC%98%E4%B9%8B%E7%9C%8B%E6%87%82Oracle%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/" title="Oracle调优之看懂Oracle执行计划"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/cover/JVM.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-25</div><div class="title">Oracle调优之看懂Oracle执行计划</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/icon/Morty.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">SherlockerSun</h1><div class="author-info__desc">是可爱汉堡包啦</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/SherlockerSun" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/29505604" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">SpringBoot整合EMQX（MQTT协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81MQTT%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.1.</span> <span class="toc-text">1、MQTT协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81MQTT%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1、MQTT简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81MQTT-%E5%8D%8F%E8%AE%AE%E5%9F%BA%E6%9C%AC%E7%89%B9%E7%82%B9"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2、MQTT 协议基本特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81MQTT-%E5%BA%94%E7%94%A8%E8%A1%8C%E4%B8%9A"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3、MQTT 应用行业</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81MQTT-%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4、MQTT 协议原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81MQTT-%E5%8D%8F%E8%AE%AE%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.5.</span> <span class="toc-text">1.5、MQTT 协议基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1%E3%80%81%E4%BC%9A%E8%AF%9D%EF%BC%88Session%EF%BC%89"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">1.5.1、会话（Session）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2%E3%80%81%E8%AE%A2%E9%98%85%EF%BC%88Subscription%EF%BC%89"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">1.5.2、订阅（Subscription）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3%E3%80%81%E4%B8%BB%E9%A2%98%E5%90%8D%EF%BC%88Topic-Name%EF%BC%89"><span class="toc-number">1.1.5.3.</span> <span class="toc-text">1.5.3、主题名（Topic Name）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-4%E3%80%81%E4%B8%BB%E9%A2%98%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%88Topic-Filter%EF%BC%89"><span class="toc-number">1.1.5.4.</span> <span class="toc-text">1.5.4、主题过滤器（Topic Filter）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-5%E3%80%81%E8%BD%BD%E8%8D%B7%EF%BC%88Payload%EF%BC%89"><span class="toc-number">1.1.5.5.</span> <span class="toc-text">1.5.5、载荷（Payload）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%E3%80%81MQTT-%E5%8D%8F%E8%AE%AE%E8%BF%9B%E9%98%B6"><span class="toc-number">1.1.6.</span> <span class="toc-text">1.6、MQTT 协议进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-1%E3%80%81%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F%EF%BC%88QoS%EF%BC%89"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">1.6.1、消息服务质量（QoS）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#QoS-0%EF%BC%88%E6%9C%80%E5%A4%9A%E5%88%86%E5%8F%91%E4%B8%80%E6%AC%A1%EF%BC%89"><span class="toc-number">1.1.6.1.1.</span> <span class="toc-text">QoS 0（最多分发一次）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-2%E3%80%81QoS-%E5%9C%A8%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">1.6.2、QoS 在发布与订阅中的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-3%E3%80%81%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9-MQTT-QoS-%E7%AD%89%E7%BA%A7"><span class="toc-number">1.1.6.3.</span> <span class="toc-text">1.6.3、如何选择 MQTT QoS 等级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-4%E3%80%81%E6%B8%85%E9%99%A4%E4%BC%9A%E8%AF%9D%EF%BC%88Clean-Session%EF%BC%89"><span class="toc-number">1.1.6.4.</span> <span class="toc-text">1.6.4、清除会话（Clean Session）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-5%E3%80%81%E4%BF%9D%E6%B4%BB%E5%BF%83%E8%B7%B3%EF%BC%88Keep-Alive%EF%BC%89"><span class="toc-number">1.1.6.5.</span> <span class="toc-text">1.6.5、保活心跳（Keep Alive）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-6%E3%80%81%E4%BF%9D%E7%95%99%E6%B6%88%E6%81%AF%EF%BC%88Retained-Message%EF%BC%89"><span class="toc-number">1.1.6.6.</span> <span class="toc-text">1.6.6、保留消息（Retained Message）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-7%E3%80%81%E9%81%97%E5%98%B1%E6%B6%88%E6%81%AF%EF%BC%88Will-Message%EF%BC%89"><span class="toc-number">1.1.6.7.</span> <span class="toc-text">1.6.7、遗嘱消息（Will Message）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81EMQ-X-Cloud"><span class="toc-number">1.2.</span> <span class="toc-text">2、EMQ X Cloud</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81EMQ-X-Cloud%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、EMQ X Cloud简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81EMQ-X-Cloud%E4%BC%98%E5%8A%BF"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2、EMQ X Cloud优势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1%E3%80%81%E5%8D%8F%E8%AE%AE%E6%94%AF%E6%8C%81%E5%AE%8C%E6%95%B4"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">2.2.1、协议支持完整</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2%E3%80%81%E5%A4%9A%E7%A7%8D%E5%8D%8F%E8%AE%AE%E6%8E%A5%E5%85%A5"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">2.2.2、多种协议接入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3%E3%80%81%E5%AE%B9%E9%87%8F%E9%A2%84%E4%BC%B0%E4%B8%8E%E4%BC%B8%E7%BC%A9"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">2.2.3、容量预估与伸缩</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81EMQ-X-%E5%92%8C-RabbitMQ%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.3、EMQ X 和 RabbitMQ对比</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1%E3%80%81%E6%B5%8B%E8%AF%95%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.3.1、测试场景</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%A4%9A%E5%AF%B9%E4%B8%80"><span class="toc-number">1.2.3.1.1.</span> <span class="toc-text">1.多对一</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">1.2.3.1.2.</span> <span class="toc-text">2.一对多</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2%E3%80%81%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.3.2、测试结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%A4%9A%E5%AF%B9%E4%B8%80-1"><span class="toc-number">1.2.3.2.1.</span> <span class="toc-text">1.多对一</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E4%B8%80%E5%AF%B9%E5%A4%9A-1"><span class="toc-number">1.2.3.2.2.</span> <span class="toc-text">2.一对多</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3%E3%80%81%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">2.3.3、测试总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-4%E3%80%81%E6%B3%A8%E6%84%8F"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">2.3.4、注意</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Eclipse-Paho-Java"><span class="toc-number">1.3.</span> <span class="toc-text">3、Eclipse Paho Java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81SpringBoot%E6%95%B4%E5%90%88Eclipse-Paho-Java"><span class="toc-number">1.4.</span> <span class="toc-text">4、SpringBoot整合Eclipse Paho Java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1%E3%80%81%E5%AF%BC%E5%85%A5Maven%E4%BE%9D%E8%B5%96"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1、导入Maven依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2、配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1%E3%80%81application-yml"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">4.2.1、application.yml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2%E3%80%81MqttProperties"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">4.2.2、MqttProperties</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3%E3%80%81%E6%B7%BB%E5%8A%A0MQTT%E6%8E%A5%E5%8F%97%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.4.3.</span> <span class="toc-text">4.3、添加MQTT接受服务的客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4%E3%80%81%E6%B7%BB%E5%8A%A0MQTT%E6%8E%A5%E5%8F%97%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%9B%9E%E8%B0%83%E7%B1%BB"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.4、添加MQTT接受服务的回调类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5%E3%80%81%E6%B7%BB%E5%8A%A0MQTT%E5%8F%91%E9%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.4.5.</span> <span class="toc-text">4.5、添加MQTT发送客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6%E3%80%81%E6%B7%BB%E5%8A%A0MQTT%E5%8F%91%E9%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%9B%9E%E8%B0%83%E7%B1%BB"><span class="toc-number">1.4.6.</span> <span class="toc-text">4.6、添加MQTT发送客户端的回调类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7%E3%80%81%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.4.7.</span> <span class="toc-text">4.7、添加配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8%E3%80%81%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%97%B6%E5%80%99%E5%BC%80%E5%90%AF%E7%9B%91%E5%90%AC%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.4.8.</span> <span class="toc-text">4.8、启动服务的时候开启监听客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-9%E3%80%81%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">1.4.9.</span> <span class="toc-text">4.9、测试类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-10%E3%80%81%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.10.</span> <span class="toc-text">4.10、发送和接收消息测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-10-1%E3%80%81%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.4.10.1.</span> <span class="toc-text">4.10.1、发送消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-10-2%E3%80%81%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-number">1.4.10.2.</span> <span class="toc-text">4.10.2、接收消息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-11%E3%80%81%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.11.</span> <span class="toc-text">4.11、可能出现的问题</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88Quartz/" title="SpringBoot整合Quartz"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringBoot整合Quartz"/></a><div class="content"><a class="title" href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88Quartz/" title="SpringBoot整合Quartz">SpringBoot整合Quartz</a><time datetime="2024-07-25T05:12:06.000Z" title="发表于 2024-07-25 13:12:06">2024-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/" title="SpringBoot整合EMQX（MQTT协议）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringBoot整合EMQX（MQTT协议）"/></a><div class="content"><a class="title" href="/2024/07/25/SpringBoot%E6%95%B4%E5%90%88EMQX%EF%BC%88MQTT%E5%8D%8F%E8%AE%AE%EF%BC%89/" title="SpringBoot整合EMQX（MQTT协议）">SpringBoot整合EMQX（MQTT协议）</a><time datetime="2024-07-25T05:11:48.000Z" title="发表于 2024-07-25 13:11:48">2024-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/25/Oracle%E8%B0%83%E4%BC%98%E4%B9%8B%E7%9C%8B%E6%87%82Oracle%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/" title="Oracle调优之看懂Oracle执行计划"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/cover/JVM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Oracle调优之看懂Oracle执行计划"/></a><div class="content"><a class="title" href="/2024/07/25/Oracle%E8%B0%83%E4%BC%98%E4%B9%8B%E7%9C%8B%E6%87%82Oracle%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/" title="Oracle调优之看懂Oracle执行计划">Oracle调优之看懂Oracle执行计划</a><time datetime="2024-07-25T05:11:29.000Z" title="发表于 2024-07-25 13:11:29">2024-07-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/24/Hexo%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/" title="Hexo部署教程"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/default_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo部署教程"/></a><div class="content"><a class="title" href="/2024/07/24/Hexo%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/" title="Hexo部署教程">Hexo部署教程</a><time datetime="2024-07-24T07:50:41.000Z" title="发表于 2024-07-24 15:50:41">2024-07-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/24/%E6%88%AA%E5%9B%BE%E5%B7%A5%E5%85%B7/" title="截图工具"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://sherlockersun-images.oss-cn-hangzhou.aliyuncs.com/cover/pinpix.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="截图工具"/></a><div class="content"><a class="title" href="/2024/07/24/%E6%88%AA%E5%9B%BE%E5%B7%A5%E5%85%B7/" title="截图工具">截图工具</a><time datetime="2024-07-24T07:50:41.000Z" title="发表于 2024-07-24 15:50:41">2024-07-24</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="SherlockerSun" target="_blank">SherlockerSun</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">7</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">3</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 游戏页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tools/"><i class="anzhiyufont anzhiyu-icon-cube faa-tada" style="font-size: 0.9em;"></i><span> 工具箱</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Hexo/" style="font-size: 0.88rem;">Hexo<sup>1</sup></a><a href="/tags/JVM/" style="font-size: 0.88rem;">JVM<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>4</sup></a><a href="/tags/Oracle/" style="font-size: 0.88rem;">Oracle<sup>1</sup></a><a href="/tags/SQL/" style="font-size: 0.88rem;">SQL<sup>1</sup></a><a href="/tags/SpringBoot/" style="font-size: 0.88rem;">SpringBoot<sup>1</sup></a><a href="/tags/Springboot/" style="font-size: 0.88rem;">Springboot<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">工具<sup>1</sup></a><a href="/tags/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" style="font-size: 0.88rem;">技术分享<sup>4</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">数据库<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 0.88rem;">网络协议<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 0.88rem;">软件<sup>1</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E6%80%BB%E7%BB%93/" style="font-size: 0.88rem;">面试总结<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("07/01/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 SherlockerSun 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.cbd.int/instantsearch.js@4.60.0/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://sherlocker-twikoo.hf.space',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://sherlocker-twikoo.hf.space',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://sherlocker-twikoo.hf.space',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="//at.alicdn.com/t/c/font_4615842_imk1ubsph1.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>